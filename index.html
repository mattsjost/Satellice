<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Satellice</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.5.2/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@7.5.2/dist/ol.js"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    #wrap {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    #controls {
      background: #f5f5f5;
      padding: 8px 12px;
      border-bottom: 2px solid #ccc;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    .date-control {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .date-control label {
      font-weight: bold;
      font-size: 13px;
    }
    .date-display {
      font-family: monospace;
      font-size: 13px;
      min-width: 80px;
      text-align: center;
      padding: 4px 8px;
      background: white;
      border: 1px solid #999;
      border-radius: 3px;
    }
    .date-display.default {
      color: #666;
      font-style: italic;
    }
    .date-display.modified {
      color: #000;
    }
    button {
      padding: 5px 10px;
      cursor: pointer;
      border: 1px solid #666;
      background: white;
      border-radius: 3px;
      font-size: 12px;
      white-space: nowrap;
    }
    button:hover {
      background: #e0e0e0;
    }
    button:active {
      background: #d0d0d0;
    }
    .reset-btn {
      margin-left: auto;
      background: #0066cc;
      color: white;
      border-color: #0055aa;
      font-weight: bold;
    }
    .reset-btn:hover {
      background: #0055aa;
    }
    .zoom-control {
      display: flex;
      gap: 5px;
      margin-left: auto;
    }
    #maps {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .map {
      flex: 1;
      min-width: 0;
    }
    /* Dölj OpenLayers zoom-knappar */
    .ol-zoom {
      display: none;
    }
    
    /* Responsiv design för mobil */
    @media (max-width: 768px) {
      #controls {
        padding: 6px 8px;
        gap: 8px;
        font-size: 12px;
      }
      .date-control label {
        min-width: auto;
        font-size: 11px;
      }
      .date-display {
        min-width: 70px;
        font-size: 11px;
        padding: 3px 6px;
      }
      button {
        padding: 4px 8px;
        font-size: 11px;
      }
      .reset-btn {
        margin-left: 0;
        width: 100%;
        order: 10;
      }
      .zoom-control {
        margin-left: 0;
      }
      #maps {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
<!-- Version: 55 -->
<!-- Free tier Sentinel Hub instance - limited quota -->
<!-- If quota runs out, clone repo and use your own Sentinel Hub instance ID -->
<div id="wrap">
  <div id="controls">
    <div class="date-control">
      <label>Radar:</label>
      <button onclick="changeDate(1, -1)">◄</button>
      <div class="date-display default" id="date1">Senaste</div>
      <button onclick="changeDate(1, 1)">►</button>
    </div>
    <div class="date-control">
      <label>Optisk:</label>
      <button onclick="changeDate(2, -1)">◄</button>
      <div class="date-display default" id="date2">Senaste</div>
      <button onclick="changeDate(2, 1)">►</button>
    </div>
    <div class="zoom-control">
      <button onclick="zoomIn()">+</button>
      <button onclick="zoomOut()">−</button>
    </div>
    <button class="reset-btn" onclick="resetToLatest()">↻ Återställ</button>
  </div>
  <div id="maps">
    <div id="map1" class="map"></div>
    <div id="map2" class="map"></div>
  </div>
</div>
<script>
  // Version: 55
  // Free tier Sentinel Hub - limited monthly quota
  // -------------------------------------------------
  // ÄNDRA DESSA
  // -------------------------------------------------
  const INSTANCE_ID = "2bbec43f-37c2-460b-bf4c-3145b8b2d1c0"; // Free tier instance
  const LAYER_LEFT  = "EW_HH_DB";      // Radar layer
  const LAYER_RIGHT = "FALSK_FARG";    // Optisk layer
  const INITIAL_CENTER = ol.proj.fromLonLat([20.0, 60.2]);
  const INITIAL_ZOOM   = 10;
  
  // Molntäckning alltid 100%
  const CLOUD_COVERAGE = 100;
  
  // Startdatum - dagens datum
  const today = new Date();
  let date1 = new Date(today);
  let date2 = new Date(today);
  let initialDate1 = new Date(today);
  let initialDate2 = new Date(today);
  let date1Modified = false;
  let date2Modified = false;
  
  // -------------------------------------------------
  function formatDate(date) {
    return date.toISOString().split('T')[0];
  }
  
  function overlayLayer() {
    return new ol.layer.Tile({
      source: new ol.source.XYZ({
        url: 'https://{1-4}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}@2x.png',
        crossOrigin: 'anonymous',
        tilePixelRatio: 2
      })
    });
  }
  
  function sentinelLayer(layerId, date) {
    const dateStr = formatDate(date);
    
    console.log(`Begär layer: ${layerId}, datum: ${dateStr}`);
    
    return new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: "https://sh.dataspace.copernicus.eu/ogc/wms/" + INSTANCE_ID,
        params: {
          LAYERS: layerId,
          FORMAT: "image/png",
          TRANSPARENT: true,
          TIME: `${dateStr}/${dateStr}`,
          MAXCC: CLOUD_COVERAGE
        },
        crossOrigin: "anonymous"
      })
    });
  }
  
  const view1 = new ol.View({
    center: INITIAL_CENTER,
    zoom: INITIAL_ZOOM,
    enableRotation: false
  });
  const view2 = new ol.View({
    center: INITIAL_CENTER,
    zoom: INITIAL_ZOOM,
    enableRotation: false
  });
  
  let map1, map2;
  
  // -------------------------------------------------
  // Initialisera kartor
  // -------------------------------------------------
  function initMaps() {
    map1 = new ol.Map({
      target: "map1",
      layers: [
        sentinelLayer(LAYER_LEFT, date1),
        overlayLayer()
      ],
      view: view1,
      controls: []
    });
    
    map2 = new ol.Map({
      target: "map2",
      layers: [
        sentinelLayer(LAYER_RIGHT, date2),
        overlayLayer()
      ],
      view: view2,
      controls: []
    });
    
    updateDateDisplay(1);
    updateDateDisplay(2);
    
    // Synk pan + zoom
    let syncing = false;
    function syncViews(source, target) {
      if (syncing) return;
      syncing = true;
      target.setCenter(source.getCenter());
      target.setZoom(source.getZoom());
      target.setRotation(source.getRotation());
      syncing = false;
    }
    
    view1.on("change:center", () => syncViews(view1, view2));
    view1.on("change:resolution", () => syncViews(view1, view2));
    view2.on("change:center", () => syncViews(view2, view1));
    view2.on("change:resolution", () => syncViews(view2, view1));
  }
  
  initMaps();
  
  // -------------------------------------------------
  // Datum-kontroller
  // -------------------------------------------------
  function updateDateDisplay(mapNum) {
    const dateEl = document.getElementById('date' + mapNum);
    const date = mapNum === 1 ? date1 : date2;
    
    // Visa alltid datumet
    dateEl.textContent = formatDate(date);
    dateEl.className = 'date-display modified';
  }
  
  function changeDate(mapNum, days) {
    if (mapNum === 1) {
      const newDate = new Date(date1);
      newDate.setDate(date1.getDate() + days);
      
      // Tillåt inte datum senare än idag
      if (newDate > today) return;
      
      date1 = newDate;
      updateDateDisplay(1);
      map1.getLayers().clear();
      map1.addLayer(sentinelLayer(LAYER_LEFT, date1));
      map1.addLayer(overlayLayer());
    } else {
      const newDate = new Date(date2);
      newDate.setDate(date2.getDate() + days);
      
      // Tillåt inte datum senare än idag
      if (newDate > today) return;
      
      date2 = newDate;
      updateDateDisplay(2);
      map2.getLayers().clear();
      map2.addLayer(sentinelLayer(LAYER_RIGHT, date2));
      map2.addLayer(overlayLayer());
    }
  }
  
  function resetToLatest() {
    date1 = new Date(today);
    date2 = new Date(today);
    
    updateDateDisplay(1);
    updateDateDisplay(2);
    
    map1.getLayers().clear();
    map1.addLayer(sentinelLayer(LAYER_LEFT, date1));
    map1.addLayer(overlayLayer());
    
    map2.getLayers().clear();
    map2.addLayer(sentinelLayer(LAYER_RIGHT, date2));
    map2.addLayer(overlayLayer());
    
    view1.setCenter(INITIAL_CENTER);
    view1.setZoom(INITIAL_ZOOM);
    view2.setCenter(INITIAL_CENTER);
    view2.setZoom(INITIAL_ZOOM);
  }
  
  // -------------------------------------------------
  // Zoom-kontroller
  // -------------------------------------------------
  function zoomIn() {
    const currentZoom = view1.getZoom();
    view1.setZoom(currentZoom + 0.5);
    view2.setZoom(currentZoom + 0.5);
  }
  
  function zoomOut() {
    const currentZoom = view1.getZoom();
    view1.setZoom(currentZoom - 0.5);
    view2.setZoom(currentZoom - 0.5);
  }
</script>
</body>
</html>
